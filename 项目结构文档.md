# 昇维学习桌项目详细文档

## 项目概述

这是一个基于Python的智能学习桌系统，主要功能是通过MaixSense深度相机实现眼部到桌面的距离检测。该系统集成了计算机视觉、深度学习和相机标定等技术，为智能学习桌提供实时的姿态监测功能。

## 核心功能

- **眼部检测**：使用MediaPipe技术实现实时眼部关键点检测
- **桌面检测**：基于YOLOv8模型进行桌面目标识别和分割
- **深度感知**：通过MaixSense深度相机获取精确的深度信息
- **距离计算**：计算眼部到桌面的实时距离，支持多种深度模式
- **相机标定**：完整的双目立体标定和深度校正系统
- **实时可视化**：提供直观的检测结果可视化界面

## 项目目录结构

```
table/
├── Aurevo-haoyanli/                    # 主项目目录
│   ├── main.py                         # 主程序入口
│   ├── config.py                       # 全局配置和参数设置
│   ├── calibration_and_correction.py  # 相机标定和深度校正
│   ├── commucation_and_decode.py       # 网络通信和数据解码
│   ├── table_detection_or.py           # 桌面检测和平面拟合
│   ├── eye_recognition.py              # 眼部识别和检测
│   ├── frame_process_and_visualize_or.py # 帧处理和可视化
│   ├── caculate_distance.py            # 距离计算工具
│   ├── README.md                       # 项目说明文档
│   │
│   ├── biaoding/                       # 标定相关文件
│   │   ├── 深度标定.md                 # 深度标定流程文档
│   │   ├── 标定标准化流程.docx         # 标定标准化流程文档
│   │   ├── *.npz                       # 立体标定数据文件
│   │   ├── *.json                      # 深度校正参数文件
│   │   ├── *.py                        # 标定工具脚本
│   │   └── *.pdf                       # 标定板文件
│   │
│   ├── model/                          # AI模型文件
│   │   └── yolov8n-seg.pt             # YOLOv8分割模型
│   │
│   └── parameters/                     # 参数配置文件
│       └── table_plane_calibration.json # 桌面平面标定参数
│
├── pic/                               # 图像数据集
│   └── *.png                          # 图像文件(0.png - 193.png)
│
└── pre_depth/                         # 预处理深度数据
    └── *.npz                          # 深度数据文件(0.npz - 193.npz)
```

## 核心模块详细说明

### 1. main.py - 主程序入口
**功能**：系统的主要控制流程，集成所有功能模块

**核心流程**：
1. **初始化阶段**：
   - 解析命令行参数（相机IP、端口、深度模式等）
   - 加载相机标定数据
   - 初始化YOLO模型和MediaPipe模型
   - 加载或启动桌面平面自动标定

2. **主处理循环**：
   - 从网络获取相机帧数据
   - 调用核心处理函数`process_frame()`
   - 管理自动标定状态和锁定平面
   - 计算最终的眼部到桌面距离
   - 实时可视化结果

3. **用户交互**：
   - 'q'：退出程序
   - 's'：切换深度模式（8bit/16bit）
   - 'u'：解锁并重新标定桌面平面

**主要特性**：
- 支持16bit和8bit深度模式动态切换
- 自动桌面平面标定（100帧校准）
- EMA平滑滤波处理距离数据
- 实时FPS显示和状态监控

### 2. config.py - 全局配置管理
**功能**：统一管理系统的所有配置参数和全局变量

**主要配置类别**：

**网络通信配置**：
```python
DEFAULT_HOST = "192.168.233.1"  # 相机默认IP
DEFAULT_PORT = 80                # 相机默认端口
```

**图像和深度参数**：
```python
DEPTH_W, DEPTH_H = 320, 240          # 深度图尺寸
RGB_W_OUTPUT, RGB_H_OUTPUT = 640, 480 # RGB输出尺寸
MIN_DEPTH_MM = 10.0                   # 最小有效深度
MAX_DEPTH_MM = 2000.0                 # 最大有效深度
```

**深度转换参数**：
```python
DEPTH_8BIT_DIVISOR_PRE_CORRECTION = 5.1    # 8bit深度预校正除数
DEPTH_16BIT_SCALE_PRE_CORRECTION = 0.25    # 16bit深度预校正缩放
```

**YOLO模型配置**：
```python
YOLO_MODEL_NAME = "model\yolov8n-seg.pt"
TABLE_CLASS_ID = [41, 60]  # COCO数据集中的桌子类别ID
YOLO_CONF_THRESHOLD = 0.25 # 置信度阈值
```

**眼部检测配置**：
```python
LEFT_EYE_INDICES = [33,7,163,144,...]   # MediaPipe左眼关键点索引
RIGHT_EYE_INDICES = [362,382,381,...]   # MediaPipe右眼关键点索引
```

### 3. calibration_and_correction.py - 标定和校正系统
**功能**：负责相机标定数据加载、深度校正和平面标定管理

**核心功能**：

**1. 标定数据加载**：
```python
load_calibration_data(use_16bit_mode=False)
```
- 根据深度模式加载对应的.npz标定文件
- 提取RGB和IR相机的内参矩阵
- 计算去畸变映射表
- 创建Open3D相机内参对象

**2. 深度校正模型**：
```python
load_depth_correction_model(use_16bit_mode=False)
apply_depth_correction(depth_mm_pre_correction)
```
- 加载线性或二次多项式校正模型
- 支持以下校正公式：
  - 线性：`corrected = a * raw + b`
  - 二次：`corrected = a * raw² + b * raw + c`

**3. 深度数据处理流水线**：
```python
depth_bytes_to_mm_array()  # 原始字节转毫米
apply_depth_correction()   # 应用校正模型
apply_temporal_filter()    # 时域中值滤波
apply_spatial_filter()     # 空域高斯滤波
```

**4. 平面标定管理**：
```python
save_plane_calibration()   # 保存平面参数
load_plane_calibration()   # 加载平面参数
```

### 4. table_detection_or.py - 桌面检测和平面拟合
**功能**：使用YOLO进行桌面检测，RANSAC进行平面拟合

**核心算法**：

**1. YOLO桌面检测**：
```python
detect_table_with_yolo(rgb_image)
```
- 使用YOLOv8n-seg模型检测桌面
- 支持COCO数据集中的dining table类别
- 返回最大面积的桌面掩码和边界框

**2. 掩码后处理**：
```python
process_table_mask(mask)
```
- 形态学开运算去除噪声
- 形态学闭运算填补空洞
- 面积过滤保留最大连通区域

**3. RANSAC平面拟合**：
```python
fit_table_plane_with_ransac(depth_mm, table_mask_depth)
```
- 将2D深度图转换为3D点云
- 使用Open3D的RANSAC算法拟合平面
- 返回平面方程 `ax + by + cz + d = 0`
- 返回内点数量作为拟合质量评分

**平面拟合流程**：
1. 提取掩码区域内的有效深度点
2. 转换为相机坐标系3D点云
3. RANSAC平面分割
4. 确保法向量方向一致性
5. 返回平面参数和置信度评分

### 5. eye_recognition.py - 眼部识别系统
**功能**：基于MediaPipe的眼部关键点检测和深度获取

**核心功能**：

**1. MediaPipe初始化**：
```python
initialize_mediapipe()
```
- 支持新旧MediaPipe API
- 兼容性检测和自动适配
- 面部网格模型配置

**2. 眼部检测**：
```python
detect_eyes_with_mediapipe(rgb_image)
```
- 检测468个面部关键点
- 提取左右眼轮廓关键点
- 计算眼部中心坐标

**3. 眼部深度获取**：
```python
get_eye_depth_from_neighbor(depth_mm, eye_center_rgb)
```
- RGB坐标到深度坐标的比例转换
- 邻域中值深度提取
- 有效性检查和边界处理

**眼部关键点索引**：
- 左眼：33, 7, 163, 144, 145, 153, 154, 155, 133, 173, 157, 158, 159, 160, 161, 246
- 右眼：362, 382, 381, 380, 374, 373, 390, 249, 263, 466, 388, 387, 386, 385, 384, 398

### 6. frame_process_and_visualize_or.py - 帧处理和可视化
**功能**：单帧数据的完整处理流程和结果可视化

**处理流程**：
```python
process_frame(depth_bytes, rgb_image, cam_config)
```
1. **深度数据处理**：
   - 原始字节转毫米深度
   - 应用深度校正
   - 时域和空域滤波

2. **RGB图像处理**：
   - 去畸变处理
   - 异常情况处理

3. **目标检测**：
   - YOLO桌面检测
   - 掩码后处理和尺寸转换

4. **平面拟合**：
   - RANSAC平面拟合
   - 质量评分计算

5. **眼部检测**：
   - MediaPipe眼部检测
   - 双眼中心坐标提取

**可视化功能**：
```python
visualize_results(results, plane_is_locked_display_flag, locked_plane_details_for_viz)
```
- 桌面掩码和边界框绘制
- 眼部关键点标记
- 距离信息显示
- 系统状态指示（LOCKED/REAL-TIME）
- 深度模式显示
- 平面方程详细信息

### 7. caculate_distance.py - 距离计算工具
**功能**：3D几何计算工具集

**核心算法**：

**1. 点到平面距离**：
```python
calculate_point_to_plane_distance(point_3d, plane_model)
```
- 使用公式：`|ax + by + cz + d| / √(a² + b² + c²)`
- 返回毫米单位距离

**2. 深度像素转3D点**：
```python
depth_to_3d_point(depth_mm_value, pixel_x, pixel_y)
```
- 使用IR相机内参进行反投影
- 从像素坐标和深度值计算3D坐标
- 坐标系转换：像素坐标 → 相机坐标系

### 8. commucation_and_decode.py - 通信和解码
**功能**：与MaixSense相机的网络通信和数据解码

**通信协议**：

**1. 配置编码**：
```python
frame_config_encode(trigger_mode, deep_mode, ...)
```
- 打包相机配置参数
- 使用struct格式："<BBBBBBBBi"
- 支持深度模式、RGB模式等配置

**2. 帧数据获取**：
```python
get_frame_from_http(host, port)
```
- HTTP GET请求获取帧数据
- 超时处理和错误检查
- 返回原始字节数据

**3. 数据解码**：
```python
frame_payload_decode(frame_data, with_config)
```
- 解析帧头信息
- 提取深度和RGB数据
- 支持JPEG解码
- 数据完整性检查

**数据结构**：
- 帧头：16字节基础信息
- 配置：12字节相机配置
- 负载：深度数据 + RGB数据

## 标定系统详解

### 立体标定

项目包含完整的双目立体标定系统，支持RGB和IR相机的联合标定：

**标定文件**：
- `stereo_calibration_data16BIT.npz`：16位深度模式标定数据
- `stereo_calibration_data8BIT.npz`：8位深度模式标定数据

**标定参数**：
- `mtx1`, `dist1`：RGB相机内参和畸变系数
- `mtx2`, `dist2`：IR相机内参和畸变系数
- `R`, `T`：立体标定的旋转和平移矩阵

### 深度校正

支持深度测量精度的自动校正：

**校正流程**：
1. **数据采集**：使用`collect_depth_calibration_data.py`采集真实距离vs报告距离的数据对
2. **模型拟合**：使用`analyze_and_fit_depth_correction.py`拟合校正模型
3. **参数保存**：保存为JSON格式的校正参数文件

**校正模型**：
- 线性模型：`corrected = a * reported + b`
- 二次模型：`corrected = a * reported² + b * reported + c`

### 桌面平面标定

系统支持自动的桌面平面标定：

**标定流程**：
1. 程序启动时自动进入标定模式
2. 连续100帧检测桌面平面
3. 选择最优平面模型（基于内点数量）
4. 自动保存标定结果到`table_plane_calibration.json`

**平面方程**：存储格式为`[a, b, c, d]`，表示平面方程`ax + by + cz + d = 0`

## 数据集说明

### pic/ 目录
包含194张RGB图像文件（0.png - 193.png），这些图像可能用于：
- 算法测试和验证
- 离线处理和分析
- 标定数据集

### pre_depth/ 目录
包含194个对应的深度数据文件（0.npz - 193.npz），每个文件包含：
- 预处理后的深度数据
- 可能包含时间戳和元数据信息

## 系统特性

### 1. 多深度模式支持
- **16位模式**：高精度深度测量
- **8位模式**：快速处理模式
- **动态切换**：运行时可切换深度模式

### 2. 实时性能优化
- **EMA滤波**：指数移动平均平滑距离数据
- **时域滤波**：中值滤波去除时间噪声
- **空域滤波**：高斯滤波去除空间噪声

### 3. 鲁棒性设计
- **异常处理**：完善的错误处理机制
- **数据验证**：多层数据有效性检查
- **自动恢复**：网络断线和数据丢失的自动恢复

### 4. 用户界面
- **实时可视化**：OpenCV窗口显示检测结果
- **状态指示**：清晰的系统状态显示
- **交互控制**：键盘快捷键控制

## 技术栈

### 核心库
- **OpenCV**：计算机视觉和图像处理
- **NumPy**：数值计算和数组操作
- **MediaPipe**：面部关键点检测
- **Ultralytics**：YOLOv8模型推理
- **Open3D**：3D数据处理和可视化
- **Requests**：HTTP网络通信

### AI模型
- **YOLOv8n-seg**：轻量级目标检测和分割模型
- **MediaPipe FaceMesh**：468点面部关键点检测模型

### 数据格式
- **NPZ**：NumPy压缩数组格式，用于标定数据
- **JSON**：配置参数和校正模型存储
- **PNG**：图像数据存储

## 部署和使用

### 系统要求
- Python 3.7+
- CUDA支持（可选，用于GPU加速）
- MaixSense深度相机
- 局域网连接

### 启动命令
```bash
python main.py --host 192.168.233.1 --port 80 --depth-mode 0
```

### 命令行参数
- `--host`：相机IP地址
- `--port`：相机端口
- `--depth-mode`：深度模式（0=16bit, 1=8bit）
- `--save-video`：保存输出视频
- `--output-video`：输出视频文件名

### 运行流程
1. **初始化**：加载标定数据和AI模型
2. **标定**：自动桌面平面标定（首次运行）
3. **检测**：实时眼部和桌面检测
4. **计算**：眼部到桌面距离计算
5. **显示**：可视化结果展示

## 性能指标

### 检测精度
- **眼部检测**：基于MediaPipe的468点高精度检测
- **桌面检测**：YOLOv8的高置信度目标检测
- **深度精度**：通过标定校正后可达毫米级精度

### 实时性能
- **帧率**：支持实时处理，具体帧率取决于硬件配置
- **延迟**：低延迟的端到端处理流程
- **稳定性**：EMA滤波确保输出稳定性

### 系统稳定性
- **错误处理**：完善的异常处理和恢复机制
- **内存管理**：有效的内存使用和释放
- **网络鲁棒性**：网络中断的自动重连机制

## 扩展性和维护

### 配置管理
所有系统参数都集中在`config.py`中管理，便于调整和优化。

### 模块化设计
各个功能模块相对独立，便于单独测试和维护。

### 标定系统
完整的标定工具链，支持新设备的快速部署。

### 日志和调试
详细的控制台输出信息，便于问题诊断和性能调优。

这个项目展现了一个完整的计算机视觉应用系统，从底层的硬件通信到高层的AI算法应用，涵盖了现代智能系统开发的各个方面。系统设计考虑了实时性、精度、稳定性和可维护性等多个维度，是一个具有实际应用价值的智能学习桌监测系统。